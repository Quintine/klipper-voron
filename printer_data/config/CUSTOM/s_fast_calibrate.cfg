[gcode_macro FAST_CALIBRATE]
description: >
  Quickly home axis and mesh the print area.
  ‚Ä¢ Caps nozzle temp at 150¬†¬∞C (warns if over‚Äërequested)  
  ‚Ä¢ Heats bed & nozzle, non‚Äëblocking wait (via WAIT_HEAT_ALL)  
  ‚Ä¢ Clears old mesh, homes, then runs adaptive mesh  
  ‚Ä¢ Moves to center & probes, with step‚Äëby‚Äëstep logs
gcode:
    # ‚îÄ‚îÄ‚îÄ STEP 1: Read & Cap Requested Temps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    {% set extruder_req = params.EXTRUDER|default(0)|int %}
    {% set bed_req      = params.BED     |default(0)|int %}
    {% if extruder_req > 150 %}
        {% set capped_extruder = 150 %}
        {% set warn_msg = "‚ö†Ô∏è Nozzle temp request " ~ extruder_req|string ~ "¬∞C capped to " ~ capped_extruder|string ~ "¬∞C" %}
        RESPOND MSG="{warn_msg}"
    {% else %}
        {% set capped_extruder = extruder_req %}
    {% endif %}

    # ‚îÄ‚îÄ‚îÄ STEP 2: Status Overview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    {% set status_msg = 
        "‚öôÔ∏è Fast Calibrate Starting | Bed ‚Üí " ~ bed_req|string ~ "¬∞C" ~ " | Nozzle ‚Üí " ~ capped_extruder|string ~ "¬∞C" %}
    RESPOND MSG="{status_msg}"

    # ‚îÄ‚îÄ‚îÄ STEP 3: Begin Heating Heaters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    {% if capped_extruder > 0 %}
        {% set heat_nozzle_msg = "üî• Heating nozzle to " ~ capped_extruder|string ~ "¬∞C" %}
        RESPOND MSG="{heat_nozzle_msg}"
        M104 S{capped_extruder}
    {% else %}
        RESPOND MSG="‚ÑπÔ∏è Nozzle heating skipped (0¬∞C requested)"
    {% endif %}

    {% if bed_req > 0 %}
        {% set heat_bed_msg = "üî• Heating bed to " ~ bed_req|string ~ "¬∞C" %}
        RESPOND MSG="{heat_bed_msg}"
        M140 S{bed_req}
    {% else %}
        RESPOND MSG="‚ÑπÔ∏è Bed heating skipped (0¬∞C requested)"
    {% endif %}

    # ‚îÄ‚îÄ‚îÄ STEP 4: Non‚Äëblocking Wait for Both Temps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    WAIT_HEAT_ALL

    # ‚îÄ‚îÄ‚îÄ STEP 5: Clear Mesh & Home Axes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    RESPOND MSG="üßπ Clearing old mesh"
    BED_MESH_CLEAR

    RESPOND MSG="üè† Homing all axes if required"
    _CG28

    {% if printer.quad_gantry_level.applied|lower == 'false' %}
        RESPOND MSG="üìè Running quad gantry level"
        QUAD_GANTRY_LEVEL
    {% else %}
        RESPOND MSG="‚úîÔ∏è Gantry already leveled"
    {% endif %}

    # ‚îÄ‚îÄ‚îÄ STEP 6: Adaptive Mesh Scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    RESPOND MSG="üîç Starting adaptive mesh scan"
    BED_MESH_CALIBRATE ADAPTIVE=1

    # ‚îÄ‚îÄ‚îÄ STEP 7: Final Probe Touch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    RESPOND MSG="üìç Moving to center for probe touch"
    G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F4500
    CARTOGRAPHER_TOUCH

    # ‚îÄ‚îÄ‚îÄ STEP 8: Restore original nozzle temp & wait ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #
    {% if extruder_req > 0 %}
        {% set restore_msg = "üîÅ Restoring nozzle temp to " ~ extruder_req|string ~ "¬∞C" %}
        RESPOND MSG="{restore_msg}"
        M104 S{extruder_req}
        WAIT_HEAT_EXTRUDER
    {% endif %}

    RESPOND MSG="‚úÖ Fast calibration complete"


[gcode_macro WAIT_HEAT_ALL]
description: Wait for bed and nozzle to reach target temps
gcode:
    RESPOND MSG="‚è≥ Waiting for bed and nozzle to heat..."
    M190 S{printer.heater_bed.target}
    M109 S{printer.extruder.target}
    RESPOND MSG="üî• Bed and nozzle ready."

[gcode_macro WAIT_HEAT_EXTRUDER]
description: Wait for nozzle to reach target temps
gcode:
    RESPOND MSG="‚è≥ Waiting for nozzle to heat..."
    M109 S{printer.extruder.target}
    RESPOND MSG="üî• Nozzle ready."
